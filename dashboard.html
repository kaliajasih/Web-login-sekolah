<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Dashboard</title>
  <!-- (CSS Anda tetap sama, tidak perlu ganti) -->
</head>
<body>
  <div class="container">
    <h1 id="welcomeMsg">Welcome to Your Student Dashboard</h1>

    <div class="tabs">
      <button class="tab active" id="tab-notes-btn" aria-controls="tab-notes" aria-selected="true">Notes</button>
      <button class="tab" id="tab-chat-btn" aria-controls="tab-chat" aria-selected="false">Chat</button>
      <button class="tab" id="tab-settings-btn" aria-controls="tab-settings" aria-selected="false">Settings</button>
    </div>

    <!-- Notes tetap sama -->
    <section id="tab-notes" class="tab-content active" role="tabpanel" aria-labelledby="tab-notes-btn">
      <div class="add-note">
        <input type="text" id="noteInput" placeholder="Add a new note" aria-label="New note" />
        <button id="addNoteBtn">Add Note</button>
      </div>
      <div id="notesList"></div>
    </section>

    <!-- Bagian Chat yang Diperbarui dengan Polling -->
    <section id="tab-chat" class="tab-content" role="tabpanel" aria-labelledby="tab-chat-btn">
      <div id="chatMessages" class="chat-messages" aria-live="polite" aria-label="Chat messages"></div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Type a message..." aria-label="Chat input" />
        <button id="sendMsgBtn">Send</button>
      </div>
    </section>

    <!-- Settings tetap sama -->
    <section id="tab-settings" class="tab-content" role="tabpanel" aria-labelledby="tab-settings-btn">
      <form id="settingsForm" class="settings-form" autocomplete="on">
        <input type="text" id="editFullname" name="fullname" placeholder="Full Name" aria-label="Full Name" required />
        <input type="text" id="editUsername" name="username" placeholder="Username" aria-label="Username" required />
        <input type="password" id="editPassword" name="password" placeholder="New Password" aria-label="New Password" />
        <input type="text" id="editKelas" name="kelas" placeholder="Nama Kelas" aria-label="Class Name" required />
        <button type="submit">Save Changes</button>
      </form>
      <div class="delete-account">
        <button id="btnDeleteAccount" type="button">Delete Account</button>
      </div>
    </section>

    <button class="btn-logout" id="btnLogout" type="button">Logout</button>
  </div>

  <script>
    // --- Basic tab functionality ---
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
        });
        tab.classList.add('active');
        tab.setAttribute('aria-selected', 'true');

        const target = tab.getAttribute('aria-controls');
        tabContents.forEach(content => {
          content.classList.remove('active');
          if(content.id === target) content.classList.add('active');
        });
      });
    });

    // --- Load user data and initialize dashboard ---
    let currentUser = null;
    const welcomeMsg = document.getElementById('welcomeMsg');

    function showError(msg) {
      alert(msg);
    }

    function loadCurrentUser() {
      const userData = sessionStorage.getItem('loggedInUser');
      if (!userData) {
        window.location.href = 'index.html'; // Redirect ke login jika tidak ada user
        return false;
      }
      currentUser = JSON.parse(userData);
      welcomeMsg.textContent = `Welcome, ${currentUser.fullname || currentUser.username}!`;
      return true;
    }

    // --- Notes functions ---
    async function loadNotes() {
      try {
        const response = await fetch(`/api/notes?username=${encodeURIComponent(currentUser.username)}`);
        if (!response.ok) throw new Error('Gagal mengambil catatan');
        const notes = await response.json();
        const notesList = document.getElementById('notesList');
        notesList.innerHTML = '';
        notes.forEach(note => {
          const div = document.createElement('div');
          div.className = 'note-item';
          div.textContent = note.text;
          const btnDelete = document.createElement('button');
          btnDelete.textContent = 'Delete';
          btnDelete.addEventListener('click', () => deleteNote(note._id));
          div.appendChild(btnDelete);
          notesList.appendChild(div);
        });
      } catch (err) {
        showError(err.message);
      }
    }

    async function addNote() {
      const noteInput = document.getElementById('noteInput');
      const text = noteInput.value.trim();
      if(!text) return;
      try {
        const response = await fetch('/api/notes', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ username: currentUser.username, text })
        });
        if(!response.ok) throw new Error('Gagal menambah catatan');
        noteInput.value = '';
        loadNotes();
      } catch (err) {
        showError(err.message);
      }
    }

    async function deleteNote(id) {
      if(!confirm('Are you sure to delete this note?')) return;
      try {
        const response = await fetch('/api/notes', {
          method: 'DELETE',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ id })
        });
        if(!response.ok) throw new Error('Gagal menghapus catatan');
        loadNotes();
      } catch (err) {
        showError(err.message);
      }
    }

    // --- Chat functions dengan polling otomatis ---
    async function loadChat() {
      try {
        const response = await fetch('/api/chat');
        if(!response.ok) throw new Error('Gagal mengambil pesan chat');
        const messages = await response.json();
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';
        messages.forEach(msg => {
          const div = document.createElement('div');
          div.textContent = `${msg.user}: ${msg.text}`;
          chatMessages.appendChild(div);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll ke bawah
      } catch (err) {
        console.error('Chat load error:', err);
      }
    }

    async function sendMessage() {
      const chatInput = document.getElementById('chatInput');
      const text = chatInput.value.trim();
      if (!text) return;
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ user: currentUser.fullname || currentUser.username, text })
        });
        if (!response.ok) throw new Error('Gagal mengirim pesan');
        chatInput.value = '';
        loadChat(); // Muat ulang segera setelah kirim
      } catch (err) {
        showError(err.message);
      }
    }

    // Polling otomatis untuk chat
    let chatPollingInterval = null;
    function startChatPolling() {
      loadChat(); // Muat awal
      chatPollingInterval = setInterval(loadChat, 3000); // Update tiap 3 detik
    }
    function stopChatPolling() {
      if (chatPollingInterval) clearInterval(chatPollingInterval);
    }

    // --- Settings functions ---
    function loadSettings(){
      document.getElementById('editFullname').value = currentUser.fullname || '';
      document.getElementById('editUsername').value = currentUser.username || '';
      document.getElementById('editKelas').value = currentUser.kelas || '';
      document.getElementById('editPassword').value = '';
    }

    async function saveSettings(e) {
      e.preventDefault();
      const fullname = document.getElementById('editFullname').value.trim();
      const username = document.getElementById('editUsername').value.trim();
      const password = document.getElementById('editPassword').value;
      const kelas = document.getElementById('editKelas').value.trim();

      if(!fullname || !username || !kelas) {
        showError('Full Name, Username, and Nama Kelas wajib diisi.');
        return;
      }

      try {
        const response = await fetch(`/api/profile?username=${encodeURIComponent(currentUser.username)}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ fullname, newUsername: username, password, kelas })
        });
        const data = await response.json();
        if(data.success) {
          alert('Profil berhasil diupdate!');
          currentUser.fullname = fullname;
          currentUser.username = username;
          currentUser.kelas = kelas;
          sessionStorage.setItem('loggedInUser', JSON.stringify(currentUser));
          loadSettings();
        } else {
          showError('Gagal mengupdate profil.');
        }
      } catch (err) {
        showError(err.message);
      }
    }

    async function deleteAccount() {
      if(confirm('Apakah Anda yakin ingin menghapus akun? Tindakan ini tidak bisa dibatalkan.')) {
        try {
          const response = await fetch(`/api/profile?username=${encodeURIComponent(currentUser.username)}`, {
            method: 'DELETE'
          });
          const data = await response.json();
          if(data.success) {
            alert('Akun berhasil dihapus.');
            sessionStorage.removeItem('loggedInUser');
            window.location.href = 'index.html';
          } else {
            showError('Gagal menghapus akun.');
          }
        } catch (err) {
          showError(err.message);
        }
      }
    }

    function logout() {
      stopChatPolling(); // Hentikan polling saat logout
      sessionStorage.removeItem('loggedInUser');
      window.location.href = 'index.html';
    }

    // --- Event Listeners ---
    document.getElementById('addNoteBtn').addEventListener('click', addNote);
    document.getElementById('sendMsgBtn').addEventListener('click', sendMessage);
    document.getElementById('settingsForm').addEventListener('submit', saveSettings);
    document.getElementById('btnDeleteAccount').addEventListener('click', deleteAccount);
    document.getElementById('btnLogout').addEventListener('click', logout);

    // --- Inisialisasi saat halaman dimuat ---
    window.onload = () => {
      if(loadCurrentUser()){
        loadNotes();
        loadSettings();
        startChatPolling(); // Mulai polling chat
      }
    };
  </script>
</body>
</html>
